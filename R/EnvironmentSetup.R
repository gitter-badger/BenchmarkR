BenchmarkEnvironment <- new.env()
ExecEnvironment <- new.env(parent = BenchmarkEnvironment)

ExecEnvironment$PROFILES <- data.frame(
  # Stores timings for each script and its timed processes
  runId = character(0),   # start date and time %C%g%m%d%H%M%S
  #   and 3 digit random number generated by:
  #   as.integer(sample(0:999, 1))
  systemId = character(0),   # unique systemId
  file = character(0),    # full script name being benchmarked
  process = character(0), # name of process
  start = numeric(0),     # start time of process
  end = numeric(0),       # end time process
  duration = numeric(0)   # duration process
  , stringsAsFactors = F
)

ExecEnvironment$BENCHMARKS <- data.frame(
  # Stores benchmark results for each run
  runId = character(0),   # unique runId
  systemId = character(0),   # unique systemId
  file = character(0),    # full script name being benchmarked
  time = numeric(0)   # duration process
  , stringsAsFactors = F
)

ExecEnvironment$META <- data.frame(
  # Store system information on which benchmarking was performed
  systemId = character(0),   # unique systemId
  systemAttribute = character(0),    # full script name being benchmarked
  attributeValue = character(0)   # duration process
  , stringsAsFactors = F
)

ExecEnvironment$WARNINGS <- data.frame(
  # Stores all warnings for each benchmarked script
  runId = character(0),   # unique runId
  file = character(0),    # full script name being benchmarked
  lineOfDirectCall = integer(0)   # duration process
  , stringsAsFactors = F
)


#' installUsedPackages
#' @description Installs all packages loaded within a R script using library/require function. This scripts installs all the used packages that are not installed yet
#' @param file path to a R script.
#' @return installs packages loaded within input script.
#' @usage  installUsedPackages(file)
#' @import utils
#' @export
installUsedPackages <- function(file){
  # get used packages in input file
  usedPackages <- benchGetter(target = "UsedPackages", file = file)
  
  if(is.na(usedPackages)){
    cat(sprintf("\nNo extra packages are used by: %s\nContinue with next step...\n",file))
    return(NULL)
  }
  
  cat(sprintf("\nThese packages are used by: %s\n",file))
  print(usedPackages)
  
  # get names of already installed packages
  localPackages <- utils::installed.packages()[,1]
  
  # select used packages that are not yet installed on local machine
  missingPackages <- usedPackages[!is.element(usedPackages,localPackages)]
  
  # get names of all packages available through CRAN repository
  cranPackages <- available.packages()[,1]
  
  # select package names used by input script that are available through CRAN repo
  missingCranPackages <- missingPackages[is.element(missingPackages,cranPackages)]
  cat("\nThese packages will be installed from CRAN repo:\n")
  print(missingCranPackages)
  
  # names of packages used by input script which are not available through CRAN repo
  missingOtherPackages <- missingPackages[!is.element(missingPackages,missingCranPackages)]
  cat("\nThese packages will be installed from Bioconductor repo:\n")
  print(missingOtherPackages)
  
  # install all missing CRAN packages
  installed.packages(missingCranPackages)
  
  # install BioC installer to install packages from Bioconductor repo
  source("http://bioconductor.org/biocLite.R")
  
  # try to install all missing packages that are not available through CRAN repo
  # from bioconductor repo
  BiocInstaller::biocLite(missingOtherPackages,suppressUpdates=TRUE, suppressAutoUpdate=TRUE,
           ask=FALSE)
}
